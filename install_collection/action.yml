name: Build and install the collection
description: Build and install the collection

inputs:
  install_python_dependencies:
    description: "Install collection python dependencies"
    required: true
  source_path:
    description: "Path to the collection source"
    required: true
  artifact_name:
    description: The name of the uploaded artifact
    required: true
outputs:
  collection_path:
    description: Path where the collection was installed to
    value: ${{ steps.identify.outputs.collection_path }}

runs:
  using: composite
  steps:
    - name: Install bindep from pypi
      run: sudo python3 -m pip install bindep
      shell: bash

    - name: Download built collection
      id: download
      uses: actions/download-artifact@v3
      with:
        name: ${{ inputs.artifact_name }}
        path: ${{ inputs.source_path }}

    - name: Extract metadata from galaxy.yml
      id: identify
      uses: Qalthos/github_actions/identify_collection@dependencies
      with:
        source_path: ${{ inputs.source_path }}

    - name: Install missing system packages using bindep.txt
      run: bindep test | tail -n +2 | xargs sudo apt-get -o Debug::pkgProblemResolver=true -o Debug::Acquire::http=true install -y || exit 0
      shell: bash
      working-directory: ${{ inputs.source_path }}

    - name: Check for missing system packages using bindep.txt
      run: bindep test
      shell: bash
      working-directory: ${{ inputs.source_path }}

    - name: Install collection python requirements
      if: ${{ inputs.install_python_dependencies == 'true' }}
      run: python3 -m pip install -r requirements.txt -r test-requirements.txt
      shell: bash
      working-directory: ${{ inputs.source_path }}

    - name: Install collection and dependencies
      run: ansible-galaxy collection install ${{ steps.download.outputs.download-path }}/*.tar.gz -p /home/runner/collections
      shell: bash
      working-directory: ${{ inputs.source_path }}
